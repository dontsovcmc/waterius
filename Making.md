
Вопросы по изготовлению создавайте тут: [issues](https://github.com/dontsovcmc/waterius/issues)

## Схема

Электрическая схема: 
<img src="https://github.com/dontsovcmc/waterius/blob/master/Board/scheme.png" data-canonical-src="https://github.com/dontsovcmc/waterius/blob/master/Board/scheme.png" width="64"/> 

## Компоненты ESP-01
* однослойная плата 61 х  14 мм ([плата для ЛУТ](https://github.com/dontsovcmc/ImpCounter/raw/master/Board/waterius-homemade-board.png)
* ESP-01
+ USB-TTL 3.3в для прошивки ESP8266

Вот так выглядит заводская плата с напаенными элеметами:

<img src="https://github.com/dontsovcmc/waterius/raw/master/Board/waterius-factory-board.jpg" data-canonical-src="https://github.com/dontsovcmc/waterius/raw/master/Board/waterius-factory-board.jpg" width="400"/>

Напишите мне, у меня много плат

### Исполнение без стабилизатора

Убираем 2 конденсатора на 1 мкФ. Оставляем 10мкФ или меньший по питанию.
Подключать две батарейки! Лучше всего литиевые (дороже алкалиновых).
Чтобы максимизировать время работы устройства от двух батареек, необходимо купить Attiny85V (для пониженного напряжения), тогда счетчик должен работать вплоть до 2.5В. Обычная Attiny85 работает до 2.7В. 
Напряжение питания вы видите в blynk на виртуальном пине V2.

### Примечания

1. У ESP-01 необходимо удалить оба сведидода. Я это делаю разрезанием дорожки ножом между светодиодом и резистором.
2. У ESP-01 необходимо снять пластиковую основу контактов и откусить 2мм от каждого пина, чтобы микроконтроллер влез по высоте в корпус.

### Изготовление корпуса

1. Дырка под разъем в крышке батарейного блока.
2. 2 отверстия под кнопку и под светодиод. 

Будьте аккуратны при разрезании пластикового корпуса. Лучше всего это делать бормашникой или дрелью. 

### Тестирование

Сначала протестируйте плату без ESP.
1. Проверьте отсутствие коротких замыканий на плате.
2. Ток потребления с непрошитой Attiny85 через стабилизатор должен быть 300-600мкА
3. Ток потребления с прошитой Attiny85 через стабилизатор должен быть 7-11мкА. 
4. Вы можете проверить на ардуине работу Attiny85 по i2c и подсчет импульсов. Для этого загрузите прошивку с TEST_WATERIUS, а также возьмите обычную Ардуино, загрузив в нее проект tests\test_attiny85 (поменяйте platformio.ini в соответствии с используемой платой). Подключите A1, A0 к входам счетчика, а A4, A5 к линии i2c. Раз в 10 секунд в консоли вы должны видеть обмен и увеличение кол-ва импульсов. Baudrate: 115200 
Ток потребления Attiny85 со стабилизатором будет ~18 мкА

5. Ток потребления Вотериуса с только что прошитой ESP, которая не разу не была включена ~2мА.
Ток потребления Вотериуса с ESP после выполнения настройки и корректного подключения к точке доступа 15-25 мкА.

6. Если Вотериус при настройке не может подключиться к точке доступа (светодиод горит больше 10 сек после нажатия ОК), зайдите еще раз на его веб страницу. Чтобы прекратить попытку подключения отсоедините батарейки.

7. Посмотреть лог работы ESP можно подключив USB-TTL переходник к выводу LOG (TX pin ESP)

